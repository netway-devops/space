<?php
/*************************************************************
 *
 * Hosting Module Class - KBang Payment
 * 
 * http://dev.hostbillapp.com/dev-kit/provisioning-modules/
 * http://wiki.hostbillapp.com/index.php?title=Custom_Modules#Examples
 * http://wiki.hostbillapp.com/index.php?title=Hosting_Modules
 * http://hostbillapp.com/features/
 * http://wiki.hostbillapp.com/index.php?title=HostBill_Plugins
 * 
 * 
 ************************************************************/


class kbank_vedc extends PaymentModule {
    
    // Extras >> Plugins >> Hosting Modules
    // Module name
    protected $modname = "Credit Card (VEDC)";
    
    // Extras >> Search results
    // Description module
    protected $description = "Kbank integration with HostBill. Additionally trough client functions it allows to browse usage graphs generated by Rvglobalsoft.com.";
    
    
    // Configuration
    protected $configuration = array(
         'MERCHANT2' => array(
            'value' => '',
            'type' => 'input',
            'description' => 'Issued by KBANK'
        ),
        'TERM2' => array(
            'value' => '',
            'type' => 'input',
            'description' => 'Issued by KBANK'
        ),
         'IPCUST2' => array(
            'value' => '0',
            'type' => 'input',
            'description' => 'IP address of merchant\'s IP Address e.g.server'
        ),
        'FILLSPACE' => array(
            'value' => 'Y',
            'type' => 'input',
            'description' => 'Y : Want to know the transaction s card type ,N : Do not want'
        ),
    );

    /**
     * 
     * drawForm
     *
     */
    public function drawForm() {
        $url    = (isset($_SERVER['HTTPS']) ? 'https://' : 'http://') . $_SERVER['HTTP_HOST'] . $_SERVER['SCRIPT_NAME'];
        $amountNet      = $this->amount*100;
        $amountFormat   = sprintf('%012s', $amountNet);
        $checksum   = md5(
            $this->configuration['MERCHANT2']['value'] .
            $this->configuration['TERM2']['value'] .
            $amountNet .
            $url . '?cmd=clientarea&action=invoice&id='. $this->invoice_id .
            $this->callback_url .
            $this->configuration['IPCUST2']['value'] .
            $this->invoice_id .
            $this->invoice_id
        );

        $string = "\n<form action='https://rt05.kasikornbank.com/pgpayment/payment.aspx' name='sendform' method='POST'>";
        
        $string.="\n<input type='hidden' name='MERCHANT2' value='{$this->configuration['MERCHANT2']['value']}'/>";
        $string.="\n<input type='hidden' name='TERM2' value='{$this->configuration['TERM2']['value']}'/>";
        $string.="\n<input type='hidden' name='AMOUNT2' value='{$amountFormat}'/>";
        $string.="\n<input type='hidden' name='URL2' value='{$url}?cmd=clientarea&action=invoice&id={$this->invoice_id}'/>";
        $string.="\n<input type='hidden' name='RESPURL' value='{$this->callback_url}'/>";
        $string.="\n<input type='hidden' name='IPCUST2' value='{$this->configuration['IPCUST2']['value']}'/>";
        $string.="\n<input type='hidden' name='DETAIL2' value='{$this->invoice_id}'/>";
        $string.="\n<input type='hidden' name='INVMERCHANT' value='{$this->invoice_id}'/>";
        $string.="\n<input type='hidden' name='checksum' value='{$checksum}'/>";

         //draw hidden field with return url
         $string.="\n<input type='submit' value='Pay now!' />";
         $string.="\n</form>";
        // $string.="<script>document.paykbank.submit();</script>";

         return $string;
      }
      
	function _verifykbank($codeKBank)
	{
		$db     = hbm_db();
		$transaction_id = substr($codeKBank, 14, 6);
		$verified = (substr($codeKBank, 0, 2) == '00') ? true: false;
		$q    = $db->query("
			SELECT 
				*
			FROM
				hb_transactions
			WHERE 
				trans_id = :trans_id
			", array(':trans_id' => $transaction_id))->fetch();
			// มี transaction แล้ว อีกอย่างคือ จ่ายแบบตัดบัตรไม่ผ่าน
		if ($q || $verified == false) {
			return false;
		} else {
			return true;
		}
	}
    /**
     * CallBack
     */
      /*
       ltrim($text, "0");
       * */
      //$_REQUEST['PMGWRESP'] ="00XXXXXXXXXXXXT03326XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX00000000622706082013131556000000001000XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXMASTERCARDXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX764XXXXXXXXXXXX";
	function callback() 
	{
		$codeKBank = $_POST['PMGWRESP'];
		$isVerify = $this->_verifykbank($codeKBank);
		//1. verify data
		// if($verified && preg_match('^/https:\/\/rt05\.kasikornbank\.com\/', $_SERVER['HTTP_REFERER'])) {
		if($isVerify) {
            //2. log incoming payment
			$this->logActivity(array(
             	'result'=>'Successfull',
             	'output'=>$_POST
            ));
            
            //3. add transaction to invoice       
            $invoice_id=  substr($codeKBank, 56, 12);//$_POST['invoiceid'];
            $invoice_id = ltrim($invoice_id, "0");
            $amount= substr($codeKBank, 82, 12);//$_POST['amount'];
            $amount= (ltrim($amount, "0"))/100;
            $fee = $_POST['fee'];
            $transaction_id = substr($codeKBank, 14, 6);//substr($codeKBank, 2, 12);//$_POST['txn_id'];
            $this->addTransaction(array(
             	'in'=>$amount,
             	'invoice_id'=>$invoice_id,
             	'fee'=>$fee,
             	'transaction_id'=>$transaction_id
            ));
			
            //3.sendmail
            $subject = 'Netway Kbank:: Order';
            $headers = 'From: admin@netway.co.th' . "\r\n" .
            'Reply-To: admin@netway.co.th' . "\r\n" .
            'X-Mailer: PHP/' . phpversion();
    
            $message = "KASIKORN BANK :: Summary Order\n";
            $message .= "--------------------------------------------\n";
            $message .= "Invoice No: " . $invoice_id . "\n";
            $message .= "Amount: " . $amount . " " . $currency . "\n";
    
            @mail('siripen@netway.co.th,thananun@netway.co.th', $subject, $message, $headers);
            
		} else {
			$this->logActivity(array(
             'result'=>'Failure',
             'output'=>$_POST
            ));
		}
    } 
}
/*
 
 function sendMailRW($aData)
{
        // Send Email to MAILADMIN
        $subject = 'Web Experts :: Summary Order';
        $headers = 'From: bus@webexperts.co.th' . "\r\n" .
        'Reply-To: bus@webexperts.co.th' . "\r\n" .
        'X-Mailer: PHP/' . phpversion();

        $message = "KASIKORN BANK :: Summary Order\n";
        $message .= "--------------------------------------------\n";
        $message .= "Merchant ID: " . $aData['merchantid'] . "\n";
        $message .= "Invoice No: " . $aData['order_no'] . "\n";
        $message .= "Amount: " . $aData['amount'] . " " . $aData['currency'] . "\n";
        $message .= "Payment For: " . trim($aData['detail']) . "\n";

        @mail(MAILADMIN, $subject, $message, $headers);
        @mail('bus@webexperts.co.th', $subject, $message, $headers);
}

 
 
 
 
 
      *รอทดสอบ สงสัยว่าตอ้งใส่ client_id ด้วย
     *this->addTransaction(array(
                    'client_id' => $this->client['client_id'],
                ));
        $string="<form action='https://rt05.kasikornbank.com/pgpayment/payment.aspx' method='POST'>";
         //draw submit button
         $string.="<input type='submit' value='Pay now!' />";

         //draw hidden fields with payment details
         $string.="<input type='hidden' name='invoice_id' value='{$this->invoice_id}'/>";
         $string.="<input type='hidden' name='amount' value='{$this->amount}'/>";
         $string.="<input type='hidden' name='currency_code' value='".$this->getCurrency()."'/>";

         //draw hidden field with return url
         $string.="<input type='hidden' name='callaback_url' value='{$this->callback_url}'/>";

          //draw hidden fields with client details
         $string.="<input type='text' name='aaaa' value='{$aaaa}'/>";
         $string.="<input type='hidden' name='firstname' value='{$this->client['firstname']}'/>";
         $string.="<input type='hidden' name='lastname' value='{$this->client['lastname']}'/>";
         $string.="<input type='hidden' name='country' value='{$this->client['country']}'/>";
         $string.="<input type='hidden' name='address' value='{$this->client['address1']}'/>";
         $string.="</form>";
*/
      /*
         SGL::logMessage(null, PEAR_LOG_DEBUG);
        $time                   = time();
        $input->order_id        = substr($input->codeKBank, 57, 12);
        $input->payment_status  = (substr($input->codeKBank, 0, 2) == '00') ? 'completed' : 'denied';
        $input->payment_value   = substr($input->codeKBank, 83, 12);
        $input->payment_number  = substr($input->codeKBank, 3, 12);

     //   SGL::logMessage('darawan sta= '.$input->payment_status .' ,value='.$input->payment_value.', num='.$input->payment_number, PEAR_LOG_DEBUG);
        $aParamPostBack     = array(
            'orderId'           => $input->order_id,
            'paymentMethod'     => 'creditcard',
            'paymentStatus'     => $input->payment_status,
            'amount'            => $input->payment_value,
            'transactionDate'   => $time,
            'transactionCode'   => $input->payment_number,
            'rawData'           => $input->codeKBank
        );
        
        $oPostBack  = new PostbackModel($aParamPostBack);
        
        $this->_process($oPostBack);
       * */