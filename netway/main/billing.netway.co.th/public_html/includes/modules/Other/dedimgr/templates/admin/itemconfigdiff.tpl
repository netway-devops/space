<h1> 
    <strong><a href="?cmd=dedimgr&do=floors&colo_id={$rack.colo_id}">Colocation: {$rack.coloname}</a></strong>
    &raquo; <strong><a href="?cmd=dedimgr&do=floor&floor_id={$rack.floor_id}">Floor: {$rack.floorname}</a> <em>{if $rack.room} Room: {$rack.room}{/if}</em></strong>
    &raquo; <strong><a href="?cmd=dedimgr&do=rack&rack_id={$rack.id}">Rack: {$rack.name}</a> </strong>
    {foreach from=$stack item=sti}
        &raquo; {$sti.category_name} - {$sti.name} {if $sti.label}&raquo; {$sti.label}{/if}  #{$sti.id}
    {/foreach}

</h1>
<link rel="stylesheet" type="text/css" href="{$moduledir}css/diffview.css"/>
<script type="text/javascript" src="{$moduledir}js/diffview.js"></script>
<script type="text/javascript" src="{$moduledir}js/difflib.js"></script>
<form action="?cmd=dedimgr&action=itemconfigedit&item_id={$item.id}&id={if $entry.id}{$entry.id}{else}new{/if}" method="POST">
    <table style="width: 100%" cellpadding="6" cellspacing="0">
        <tr>
            <td>
                <select id="left" class="inp" style="width: 100%">
                    {foreach from=$configs item=conf}
                        <option value="">----</option>
                        <optgroup label="{$conf.active.description|escape}">
                            {if $conf.active}
                                <option value="{$conf.active.id}">{$conf.active.description|escape} ({$conf.active.date|dateformat:$date_format}, {$conf.active.author})</option> 
                            {/if}
                            {foreach from=$conf.archived item=entry}
                                <option value="{$entry.id}">{$entry.description|escape} {$entry.date|dateformat:$date_format}, {$entry.author})</option>  
                            {/foreach}
                        </optgroup>
                    {/foreach}
                </select>
                <textarea id="lefttarget" style="display: none"></textarea>
            </td>
            <td>
                <select id="right" class="inp" style="width: 100%">
                    <option value="">----</option>
                    {foreach from=$configs item=conf}
                        <optgroup label="{$conf.active.description|escape}">
                            {if $conf.active}
                                <option value="{$conf.active.id}">{$conf.active.description|escape} ({$conf.active.date|dateformat:$date_format}, {$conf.active.author})</option> 
                            {/if}
                            {foreach from=$conf.archived item=entry}
                                <option value="{$entry.id}">{$entry.description|escape} ({$entry.date|dateformat:$date_format}, {$entry.author})</option>  
                            {/foreach}
                        </optgroup>
                    {/foreach}
                </select>
                <textarea id="righttarget" style="display: none"></textarea>
            </td>
        </tr>
    </table>
    <div id="diffoutput">
        <table class="diff inlinediff">
            <thead>
                <tr>
                    <th></th><th></th>
                    <th class="texttitle">---- vs. ----</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>1</th>
                    <td class="equal" colspan="2" style="text-align: center; color:grey">Select configurations to compare</td>
                </tr>
                <tr>
                    <th class="author" colspan="3">diff view generated by <a href="http://github.com/cemerick/jsdifflib">jsdifflib</a></th>
                <tr>
            </tbody>
        </table>
    </div>
</form>

{literal}
    <script type="text/javascript">

        function diffUsingJS() {
            var left = difflib.stringAsLines($('#lefttarget').val()),
                    right = difflib.stringAsLines($('#righttarget').val()),
                    sm = new difflib.SequenceMatcher(right, left),
                    opcodes = sm.get_opcodes(),
                    diffoutputdiv = $("#diffoutput"),
                    contextSize = null;
            console.log(right, left)
            diffoutputdiv.html('').append(diffview.buildView({
                baseTextLines: right,
                newTextLines: left,
                opcodes: opcodes,
                baseTextName: $('#left option:selected').text(),
                newTextName: $('#right option:selected').text(),
                contextSize: contextSize,
                viewType: 1
            }));

        }
        $('#left, #right').change(function() {
            var that = $(this);
            $.post('?cmd=module&module={/literal}{$moduleid}{literal}&action=itemconfigdiff', {item_id: 32, id: that.val()}, function(data) {
                if (data && data.config) {
                    $('#' + that.attr('id') + 'target').val(data.config);
                }
                diffUsingJS();
            })
        });
    </script>
{/literal}